<script type="module">
    import { render, createElement as el, Fragment } from 'https://unpkg.com/@wordpress/element@latest/build-module/index.js';
    import { Button } from 'https://unpkg.com/@wordpress/components@latest/build-module/index.js';
    import * as lucide from 'https://unpkg.com/lucide/dist/esm/lucide.js';

    // Import html2pdf.js for PDF export
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
    document.head.appendChild(script);

    // When injected, window.profileData will be available from index.html
    const d = window.profileData || {};

    const App = () => {
      // Social icons mapping with Lucide icons
      const getSocialIcon = (platform) => {
        const icons = {
          twitter: 'Twitter',
          x: 'Twitter', // Support both Twitter and X
          linkedin: 'Linkedin',
          github: 'Github',
          facebook: 'Facebook',
          instagram: 'Instagram',
          youtube: 'Youtube',
          tiktok: 'Music',
          mastodon: 'Share2',
          dribbble: 'Dribbble',
          behance: 'Figma',
          medium: 'BookOpen',
          dev: 'Code',
          stackoverflow: 'Layers',
          default: 'Link'
        };
        
        // Get the icon name based on platform, with fallback to default
        const iconName = icons[platform.toLowerCase()] || icons.default;
        
        // Create a div to hold the SVG icon
        const iconContainer = document.createElement('div');
        
        // Different theme styling based on UI theme
        const themeStyles = {
          wds: { stroke: '#2271b1', background: '#f0f0f1' },
          default: { stroke: '#555', background: '#f0f0f1' }
        };
        
        // Use theme from profile, with fallback to default
        const theme = d.ui || 'default';
        const style = themeStyles[theme] || themeStyles.default;
        
        // Check if the icon exists in lucide
        if (lucide[iconName]) {
          // Create the SVG element
          iconContainer.innerHTML = lucide[iconName].toSvg({ 
            color: style.stroke,
            size: 20,
            strokeWidth: 1.5
          });
          return iconContainer.firstChild;
        }
        
        // Fallback to generic icon
        iconContainer.innerHTML = lucide.Link.toSvg({ 
          color: style.stroke,
          size: 20,
          strokeWidth: 1.5
        });
        return iconContainer.firstChild;
      };

      const downloadPDF = () => {
        const element = document.getElementById('bio-container');
        const opt = {
          margin: 10,
          filename: `${d.name}-bio.pdf`,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        // Use window.html2pdf to ensure it's loaded
        if (window.html2pdf) {
          window.html2pdf().set(opt).from(element).save();
        } else {
          console.error('html2pdf.js not loaded yet');
          alert('PDF generator is loading, please try again in a moment.');
        }
      };

      // Social icons section
      const socialIcons = (d.social || []).length > 0 ? 
        el('div', {
          style: {
            display: 'flex',
            flexWrap: 'wrap',
            justifyContent: 'center',
            gap: '0.75rem',
            margin: '1rem 0 1.5rem'
          }
        }, 
        d.social.map(social => 
          el('a', {
            href: social.url,
            target: '_blank',
            rel: 'noopener noreferrer',
            title: social.platform,
            style: {
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              width: '40px',
              height: '40px',
              borderRadius: '50%',
              background: d.ui === 'wds' ? '#f0f0f1' : '#f0f0f1',
              transition: 'background-color 0.2s, transform 0.2s'
            },
            onMouseOver: (e) => {
              e.currentTarget.style.background = '#dcdcde';
              e.currentTarget.style.transform = 'translateY(-3px)';
            },
            onMouseOut: (e) => {
              e.currentTarget.style.background = '#f0f0f1';
              e.currentTarget.style.transform = 'translateY(0)';
            },
            ref: (node) => {
              if (node) {
                // Clear previous content
                while (node.firstChild) {
                  node.removeChild(node.firstChild);
                }
                // Add the SVG icon
                node.appendChild(getSocialIcon(social.platform));
              }
            }
          })
        ))
      ) : null;

      const linkSections = (d.links || []).map(section =>
        el(Fragment, {},
          [
            el('h3', {
              style: {
                marginTop: '1.5rem',
                fontWeight: 'bold',
                fontSize: '1.1rem'
              }
            }, section.category),
            el('ul', {
              style: {
                listStyle: 'none',
                paddingLeft: 0,
                marginTop: '0.5rem'
              }
            },
              (section.items || []).map(link =>
                el('li', { style: { marginBottom: '0.5rem' }, key: link.url },
                  el('a', {
                    href: link.url,
                    target: '_blank',
                    rel: 'noopener noreferrer',
                    style: { color: '#2271b1', textDecoration: 'none' }
                  }, link.title)
                )
              )
            )
          ]
        )
      );

      return el('div', {
        id: 'bio-container',
        style: {
          maxWidth: '640px',
          margin: 'auto',
          fontFamily: 'system-ui, sans-serif',
          padding: '2rem',
          lineHeight: 1.6,
          background: '#fff',
          borderRadius: '18px',
          boxShadow: '0 2px 32px 0 rgba(0,0,0,0.08)'
        }
      }, [
        el('img', {
          src: d.photo_url,
          alt: d.name,
          style: {
            width: 100,
            height: 100,
            borderRadius: '9999px',
            objectFit: 'cover',
            marginBottom: '1rem',
            boxShadow: '0 0 0 3px #eee'
          }
        }),
        el('h1', { style: { fontSize: '1.75rem', fontWeight: 'bold' } }, d.name),
        el('p', { style: { fontStyle: 'italic', color: '#555' } }, d.headline),
        el('p', {
          dangerouslySetInnerHTML: { __html: d.description },
          style: { marginTop: '1rem' }
        }),
        el('div', {
          style: {
            display: 'flex',
            flexWrap: 'wrap',
            justifyContent: 'center',
            gap: '0.8rem',
            margin: '1.5rem 0'
          }
        }, [
          el(Button, {
            variant: 'primary',
            href: `mailto:${d.email}`,
          }, d.cta?.text || 'Contact Me'),
          el(Button, {
            variant: 'secondary',
            onClick: downloadPDF,
          }, 'Download as PDF')
        ]),
        socialIcons,
        ...linkSections
      ]);
    };

    render(el(App), document.getElementById('root'));
  </script>